![CrowdSec Logo](images/logo_crowdsec.png)
# CrowdSec Bouncer extension for Magento 2

## User Guide


<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**

- [Description](#description)
- [Prerequisites](#prerequisites)
- [Usage](#usage)
  - [Features](#features)
  - [Configurations](#configurations)
    - [General Settings](#general-settings)
    - [Theme customizations](#theme-customizations)
    - [Advanced settings](#advanced-settings)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->



## Description

The `CrowdSec Bouncer` extension for Magento 2 has been designed to protect Magento 2 websites from all kinds of attacks by using [CrowdSec](https://crowdsec.net/) technology.

## Prerequisites

To be able to use this bouncer, the first step is to install [CrowdSec v1](https://doc.crowdsec.net/Crowdsec/v1/getting_started/installation/).

Please note that first and foremost CrowdSec must be installed on a server that is accessible via the Magento 2 site.


## Usage

### Features

When a user is suspected to be malevolent, CrowdSec will either send him/her a Captcha to resolve or simply a page notifying that access is denied. 

By default, the ban wall is displayed as below:

![Ban wall](images/screenshots/front-ban.jpg)

By default, the captcha wall is displayed as below:

![Captcha wall](images/screenshots/front-captcha.jpg)

Please note that it is possible to customize all the colors of these pages in a few clicks so that they integrate best with your design. 

On the other hand, all texts are also fully customizable. This will allow you, for example, to present translated pages in your users’ language.


### Configurations

This module comes with configurations that you will find under `Stores → Configurations → Security → CrowdSec Bouncer` admin section.

These configurations are divided in three main parts : `General Settings`, `Theme customizations` and `Advanced settings`.


#### General Settings

  In the `General settings` part, you will set your connection details and refine bouncing according to your needs.
  
![Connection details](images/screenshots/config-connection-details.jpg)

***

 `Connection details → Your LAPI Url` (`global` scope) 
 
Url to join your CrowdSec LAPI.
 
***
 
 `Connection details → Your bouncer key` (`global` scope)
 
Key generated by the cscli command.


**N.B** : Even before saving configuration, you can check if your settings are correct by clicking on the test button.

 ***

![Bouncing](images/screenshots/config-bouncing.jpg)


***

 `Bouncing → Enable bouncer on Frontend area` (`store view` scope) 
 
Choose which store views you want to protect.
 
***

 `Bouncing → Enable bouncer on Adminhtml area` (`global` scope) 
 
Choose if you want to protect admin too.
 
***

  `Bouncing → Enable bouncer on API areas` (`global` scope) 
  
Choose if you want to protect REST, SOAP and GraphQL endpoints.


**N.B** : For API calls, there will be no ban or captcha wall. User will receive a `401` (ban) or `403` (captcha) response code.

***

  `Bouncing → Bouncing level` (`store view` scope) 
  
Choose if you want to apply CrowdSec directives (Normal bouncing) or be more permissive (Flex bouncing).

With the `Flex mode`, it is impossible to accidentally block access to your site to people who don’t deserve it. This 
mode makes it possible to never ban an IP but only to offer a Captcha, in the worst-case scenario.
 
***



#### Theme customizations

 In the `Theme customizations` part, you can modify texts and colors of ban and captcha walls. All fields here are 
 store view scoped, so you can use different languages and designs.

![Captcha customization](images/screenshots/config-captcha-wall.jpg)

![Captcha customization](images/screenshots/config-ban-wall.jpg)

![Captcha customization](images/screenshots/config-css.jpg)



####  Advanced settings


  In the `Advanced settings` part, you can enable/disable the stream mode, choose your cache system for your CrowdSec 
  LAPI, handle your remediation policy and adjust some debug and log parameters.

![Captcha customization](images/screenshots/config-communication-mode.jpg)

***

`Communication mode to the API → Enable the stream mode` (`global` scope)

Choose if you want to enable the `stream mode` or stay in `live mode`.


By default, the `live mode` is enabled. The first time a stranger connects to your website, this mode means that the IP will be checked directly by the CrowdSec API. The rest of your user’s browsing will be even more transparent thanks to the fully customizable cache system.

But you can also activate the `stream mode`. This mode allows you to constantly feed the bouncer with the malicious IP list via a background task (CRON), making it to be even faster when checking the IP of your visitors. Besides, if your site has a lot of unique visitors at the same time, this will not influence the traffic to the API of your CrowdSec instance.

***

`Communication mode to the API → Cron expression for cache refresh` (`global` scope)

With the stream mode, every decision is retrieved in an asynchronous way. Here you can define the frequency of this 
cache refresh.

**N.B** : There is also a refresh button if you want to refresh the cache manually.


***


![Captcha customization](images/screenshots/config-cache.jpg)

***

`Cache configuration → Technology` (`global` scope)

Choose the cache technology that will use your CrowdSec LAPI.

The File system cache is faster than calling LAPI. Redis or Memcached is faster than the File System cache.

**N.B** : There are also a clear cache button fo all cache technologies and a prune cache button dedicated to the 
file system cache.

***


`Cache configuration → Redis DSN` (`global` scope)

Only if you choose Redis cache as technology. Example of DSN: redis://localhost:6379.

***


`Cache configuration → Memcached DSN` (`global` scope)

Only if you choose Memcached cache as technology. Example of DSN: memcached://localhost:11211.

***


`Cache configuration → Clean IPs cache duration` (`global` scope)

The duration between re-asking LAPI about an already checked clean IP.

Minimum 1 second.  Note that this setting can not be apply in stream mode.

***

`Cache configuration → Bad IPs cache duration` (`global` scope)

The duration between re-asking LAPI about an already checked bad IP.

Minimum 1 second.  Note that this setting can not be apply in stream mode.

***

![Captcha customization](images/screenshots/config-remediations.jpg)


***

`Remediations → Fallback to` (`global` scope)

Choose which remediation to apply when CrowdSec advises unhandled remediation.

***


`Remediations → Trust these CDN Ips` (`global` scope)

If you use a CDN, a reverse proxy or a load balancer, it is possible to indicate in the bouncer settings the IP ranges of these devices in order to be able to check the IP of your users. For other IPs, the bouncer will not trust the X-Forwarded-For header.

***

`Remediations → Hide CrowdSec mentions` (`global` scope)

Enable if you want to hide CrowdSec mentions on the Ban and Captcha walls.
***

![Captcha customization](images/screenshots/config-debug.jpg)

***

`Configure the debug mode → Enable debug log` (`global` scope)

Enable if you want to see some debug information in a specific log file.

***

`Configure the debug mode → Display bouncings errors` (`global` scope)

When this mode is enabled, you will see every unexpected bouncing errors in the browser.

***

`Configure the debug mode → Disable prod log` (`global` scope)

The prod log is lighter than the debug log. But you can disable it here.

***



  


 
